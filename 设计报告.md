# 集创赛校赛设计报告

## 赛题四

使用硬件描述语言如 Verilog、VHDL等，实现三通道3x3卷积内核，具体要求如下:

1. 学习FPGA神经网络加速器的加速原理；
2. 实现一个简单的三通道3x3卷积内核，并且使用modelsim、iverilog、verilator等其中一种仿真工具，生成波形图等仿真文件，以展示相应效果；
3. 提高部分:对所设计的内核进行并行加速、切割流水线，应用winograd算法（选做)；

## 设计使用软件版本
* Quartus Prime 17.1 
* Modelsim SE-64 10.1c
## 第一部分 FPGA神经网络加速器原理



## 第二部分 三通道3X3卷积核设计

- ### **题目分析：**

  在进行卷积核设计前，首先要确定单个数据的数据格式，本设计中指定为16位浮点数（半精度浮点数）。其次考虑到卷积运算需要包含乘法和加法，因此需要设计乘法器和加法器两种电路。

- ### **半精度浮点数原理：**

  IEEE754-2008包含一种“半精度”格式，只有16位宽。故它又被称之为binary16。与单精度浮点数相比，它的优点是只需要一半的存储空间和带宽，但是缺点是精度较低。其结构图如下：

![](C:\Users\26825\Desktop\集创赛\校内初赛\题目\picture\float16.png)

 

半精度的格式与单精度的格式类似，最左边的一位仍是符号位，指数有5位宽且以余-16（excess-16）的形式存储，尾数有10位宽，但具有隐含1。半精度浮点数的值的计算方式为（-1）^sign×2^（指数位的值）×（1+0.尾数位）。

- ### **乘法器设计：**

  #### 半精度浮点乘法的计算步骤如下：

  1. 首先将16位数据拆解为符号位，指数位和尾数位。之后判断是否有特殊情况，如两个乘数中有0，若有则按可直接写出结果。
  2. 其次，针对一般情况下的运算，符号位为只是两乘数符号位的异或，指数位是两乘数指数的相加，尾数位则在正常的乘法之余考虑到移位（和随之而来的指数为的溢出）和进位的情况。

  #### 半精度浮点乘法RTL视图如下：

  <img src="C:\Users\26825\AppData\Roaming\Typora\typora-user-images\image-20230223213136305.png" alt="image-20230223213136305" style="zoom:33%;" />

  设计中为了提高组合电路的时序性能，在乘法器输入端加入时钟端口（clk）和异步清零端口（rst_n）。

  #### 半精度浮点乘法器ModelSim仿真波形如下：

  ![image-20230223213906634](C:\Users\26825\AppData\Roaming\Typora\typora-user-images\image-20230223213906634.png)

  在该测试中，分别测试了4\*5 （即0x4400 \* 0x4500）和0.0004125\*0即（0x0ec2\*0x0000），输出结果为20（即0x4d00）和0（即0x0000）。测试结果正确，标明设计的电路功能正常。

- ### **加法器设计：**

  #### 半精度浮点加法的计算步骤如下：

  1. 首先将16位数据拆解为符号位，指数位和尾数位。之后判断是否有特殊情况，如两个加数中有0，或互为相反数，若有则按可直接写出结果。
  2. 其次，针对一般情况下的运算，先进行对阶，使得两个加数的阶数相同。当阶数相同后，即可进行尾数相加，得到加法结果。此外，当出现尾数溢出的情况时，可以采用右移一位，阶码减一的方式来判断阶码是否溢出，当阶码溢出时表示两数相加的结果溢出。

  #### 半精度三输入加法器RTL视图如下：

  ![image-20230223215244146](C:\Users\26825\AppData\Roaming\Typora\typora-user-images\image-20230223215244146.png)

  设计中为了方便后续对加法的并行处理，使用两个两输入加法器级联的形式构建了三输入加法器。同时为了提高组合电路的时序性能，添加了时钟端口和复位端口。

  #### 半精度浮点三输入加法器ModelSim仿真波形如下：

  ![image-20230224102601239](C:\Users\26825\AppData\Roaming\Typora\typora-user-images\image-20230224102601239.png)

  在该测试中，分别测试了0.2+0.3+0（即0x34cd+0x3266+0x0000）和0.2+0+0（即0x34cd+0x0000+0x0000=0x34cd），输出结果为0.5（即0x3800）和0.2（即0x34cd）。测试结果正确，标明设计的电路功能正常。

- ### **卷积核设计：**

  在卷积核计算中，需要进行9次乘法和8次加法。如果全部依次执行，需要17个时钟周期，降低了计算效率。为了提高运算速度，本设计中采用了加法树进行并行加速。通过使用设计的两输入乘法器和三输入加法器，通过3个时钟周期即可得出卷积结果。考虑到流水线操作，事实上，1个时钟周期，即可得出运算结果。具体的加法树结构分为三层，第三层为9个两输入加法器，第二层为3个三输入加法器，第一层为1个三输入加法器。
  ####   卷积核RTL视图如下：

  ![image-20230224103317684](C:\Users\26825\AppData\Roaming\Typora\typora-user-images\image-20230224103317684.png)

  ####   卷积核ModelSim仿真波形如下：
  
  ![image-20230224110132308](C:\Users\26825\AppData\Roaming\Typora\typora-user-images\image-20230224110132308.png)
  
  在该测试中，第一次输入数据4 4 4 4 4 4 4 4 4和5 5 5 5 5 5 5 5 5（即0x440044004400440044004400440044004400和0x450045004500450045004500450045004500）。经过三个时钟周期后，输出结果180即（0x59a0）。第二次输入数据5 5 5 5 5 5 5 5 5和5 5 5 5 5 5 5 5 5（即0x450045004500450045004500450045004500和0x450045004500450045004500450045004500）。经过三个时钟周期后，输出结果225即（0x5b08）。



## 第三部分 数据输入模块设计

<img src="C:\Users\26825\Desktop\集创赛\校内初赛\题目\picture\shift_ram.jpg" style="zoom: 25%;" />

